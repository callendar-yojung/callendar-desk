name: Tauri Build & Upload

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            platform: windows
            ext: .msi
            bundle_dir: msi
          - os: macos-latest
            target: aarch64-apple-darwin
            platform: macos
            ext: .dmg
            bundle_dir: dmg
          - os: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
            platform: linux
            ext: .deb
            bundle_dir: deb

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Install system dependencies (Ubuntu)
        if: matrix.os == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf \
            libssl-dev

      - name: Install dependencies
        run: npm ci

      - name: Build Tauri app
        run: npm run tauri:build
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}

      - name: Get version from tag
        id: version
        shell: bash
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Prepare artifacts
        id: artifacts
        shell: bash
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          PLATFORM=${{ matrix.platform }}
          EXT=${{ matrix.ext }}
          BUNDLE_DIR=${{ matrix.bundle_dir }}

          ZIP_NAME="desktop-calendar-${VERSION}-${PLATFORM}.zip"
          BUILD_DIR="src-tauri/target/release/bundle/${BUNDLE_DIR}"

          echo "ZIP_NAME=${ZIP_NAME}" >> $GITHUB_OUTPUT
          echo "BUILD_DIR=${BUILD_DIR}" >> $GITHUB_OUTPUT

          # Find and zip the artifact
          cd "${BUILD_DIR}"

          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            7z a "../../../../${ZIP_NAME}" *${EXT}
          else
            zip -r "../../../../${ZIP_NAME}" *${EXT}
          fi

          cd ../../../../

          # File size (cross-platform)
          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            FILE_SIZE=$(powershell -command "(Get-Item '${ZIP_NAME}').Length")
          elif [[ "${{ matrix.os }}" == "macos-latest" ]]; then
            FILE_SIZE=$(stat -f%z "${ZIP_NAME}")
          else
            FILE_SIZE=$(stat -c%s "${ZIP_NAME}")
          fi
          echo "FILE_SIZE=${FILE_SIZE}" >> $GITHUB_OUTPUT

          # Checksum
          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            CHECKSUM=$(powershell -command "(Get-FileHash '${ZIP_NAME}' -Algorithm SHA256).Hash.ToLower()")
          else
            CHECKSUM=$(shasum -a 256 "${ZIP_NAME}" | cut -d ' ' -f 1)
          fi
          echo "CHECKSUM=${CHECKSUM}" >> $GITHUB_OUTPUT

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Upload to S3
        id: s3_upload
        shell: bash
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          PLATFORM=${{ matrix.platform }}
          ZIP_NAME=${{ steps.artifacts.outputs.ZIP_NAME }}

          S3_PATH="s3://${{ secrets.AWS_S3_BUCKET }}/releases/v${VERSION}/${PLATFORM}/${ZIP_NAME}"
          aws s3 cp "${ZIP_NAME}" "${S3_PATH}"

          S3_URL="https://${{ secrets.AWS_S3_BUCKET }}.s3.${{ secrets.AWS_REGION }}.amazonaws.com/releases/v${VERSION}/${PLATFORM}/${ZIP_NAME}"
          echo "S3_URL=${S3_URL}" >> $GITHUB_OUTPUT

      - name: Save release info to database
        shell: bash
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          PLATFORM=${{ matrix.platform }}
          ZIP_NAME=${{ steps.artifacts.outputs.ZIP_NAME }}
          FILE_SIZE=${{ steps.artifacts.outputs.FILE_SIZE }}
          CHECKSUM=${{ steps.artifacts.outputs.CHECKSUM }}
          S3_URL=${{ steps.s3_upload.outputs.S3_URL }}

          # Escape commit message for JSON
          RELEASE_NOTES=$(echo "${{ github.event.head_commit.message }}" | head -1 | sed 's/"/\\"/g' | tr -d '\n\r')

          curl -X POST "${{ secrets.API_BASE_URL }}/api/releases" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.API_SECRET_KEY }}" \
            --fail \
            -d "{
              \"version\": \"${VERSION}\",
              \"platform\": \"${PLATFORM}\",
              \"fileName\": \"${ZIP_NAME}\",
              \"downloadUrl\": \"${S3_URL}\",
              \"fileSize\": ${FILE_SIZE},
              \"checksum\": \"${CHECKSUM}\",
              \"releaseNotes\": \"${RELEASE_NOTES}\",
              \"isPrerelease\": false
            }"

      - name: Upload artifact for release
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform }}-build
          path: ${{ steps.artifacts.outputs.ZIP_NAME }}

  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Get version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/**/*.zip
          tag_name: v${{ steps.version.outputs.VERSION }}
          name: Release v${{ steps.version.outputs.VERSION }}
          generate_release_notes: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
